<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tanques Battle Royale</title>
    <!-- Librer铆as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ESTILOS GENERALES */
        * { box-sizing: border-box; touch-action: none; user-select: none; }
        body { margin: 0; padding: 0; background: #222; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; }
        .active { display: flex; }

        /* UI MEN */
        #menu-screen { background: #1a1a1a; z-index: 10; text-align: center; }
        h1 { font-size: 3rem; color: #4CAF50; margin-bottom: 10px; }
        .btn { padding: 15px 30px; font-size: 1.2rem; background: #4CAF50; border: none; color: white; border-radius: 5px; margin: 10px; cursor: pointer; }
        input { padding: 15px; font-size: 1.2rem; border-radius: 5px; border: none; text-align: center; margin: 10px; width: 250px; }

        /* UI JUEGO (HOST) */
        #game-screen { background: #333; position: relative; }
        canvas { background: #1a1a1a; border: 2px solid #555; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        #lobby-info { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; pointer-events: none; }
        #qrcode { margin-top: 10px; background: white; padding: 5px; display: inline-block; }
        .room-code { font-size: 3rem; color: yellow; font-family: monospace; font-weight: bold; }

        /* PANTALLA GANADOR (OVERLAY) */
        #winner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #winner-name { font-size: 5rem; color: #FFD700; text-shadow: 0 0 20px #FFD700; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* UI CONTROL (MVIL) */
        #controller-screen { background: #222; }
        .control-panel { display: flex; width: 100%; height: 100%; justify-content: space-between; align-items: center; padding: 20px; }
        #joystick-zone { width: 180px; height: 180px; background: rgba(255,255,255,0.1); border-radius: 50%; position: relative; border: 2px solid rgba(255,255,255,0.2); }
        #joystick-stick { width: 70px; height: 70px; background: rgba(255,255,255,0.5); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #btn-shoot { width: 100px; height: 100px; background: #ff4444; border-radius: 50%; border: 4px solid #cc0000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        #btn-shoot:active { background: #cc0000; transform: scale(0.95); }

        /* ESTADO MVIL */
        .mobile-top-bar { position: absolute; top: 0; width: 100%; padding: 10px; display: flex; justify-content: space-between; background: rgba(0,0,0,0.5); font-weight: bold; }
        
        /* PANTALLA DERROTA MVIL */
        #dead-screen { display: none; width: 100%; height: 100%; background: #220000; color: red; flex-direction: column; justify-content: center; align-items: center; position: absolute; top:0; left:0; z-index: 50; }
        #dead-screen h1 { font-size: 3rem; margin: 0; }
    </style>
</head>
<body>

    <!-- MEN PRINCIPAL -->
    <div id="menu-screen" class="screen active">
        <h1>TANK BATTLE 2.0</h1>
        <button class="btn" onclick="initHostMode()"> Crear Sala (Pantalla)</button>
        <div style="border-top: 1px solid #444; margin: 20px; padding: 20px;">
            <input type="text" id="room-input" placeholder="C贸digo" maxlength="6">
            <input type="text" id="name-input" placeholder="Tu Nombre" maxlength="10">
            <br>
            <button class="btn" onclick="initClientMode()"> Unirse</button>
        </div>
    </div>

    <!-- PANTALLA DE JUEGO (HOST) -->
    <div id="game-screen" class="screen">
        <canvas id="gameCanvas"></canvas>
        
        <div id="lobby-info">
            <div>SALA: <span id="display-room-code" class="room-code">------</span></div>
            <div>Jugadores: <span id="player-count">0</span></div>
            <div id="qrcode"></div>
            <div id="score-board" style="margin-top:10px;"></div>
        </div>

        <!-- Overlay de Ganador -->
        <div id="winner-overlay">
            <h2 style="color:white">隆TENEMOS UN GANADOR!</h2>
            <div id="winner-name">JUGADOR</div>
            <button class="btn" onclick="location.reload()" style="margin-top:50px;">Nueva Partida</button>
        </div>
    </div>

    <!-- PANTALLA DE MANDO (CLIENTE) -->
    <div id="controller-screen" class="screen">
        <!-- Overlay Muerte -->
        <div id="dead-screen">
            <h1>PERDISTE</h1>
            <p>Espera a que termine la partida...</p>
        </div>

        <!-- Overlay Ganador M贸vil -->
        <div id="mobile-win-screen" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:#002200; z-index:60; flex-direction:column; justify-content:center; align-items:center;">
            <h1 style="color:#0f0; font-size:3rem;">隆GANASTE!</h1>
            <p>Eres el 煤ltimo superviviente</p>
        </div>

        <div class="mobile-top-bar">
            <span id="ctrl-name">Jugador</span>
            <span>HP: <span id="ctrl-hp">わわ</span></span>
        </div>

        <div class="control-panel">
            <div id="joystick-zone">
                <div id="joystick-stick"></div>
            </div>
            <div id="shoot-zone">
                <div id="btn-shoot">FIRE</div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIN FIREBASE (REEMPLAZAR AQU)
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyBb4BGWFS5a2RA1jfyW-z1m-Ai9sMgx3yk",
  authDomain: "tanksgame-5ac51.firebaseapp.com",
  databaseURL: "https://tanksgame-5ac51-default-rtdb.firebaseio.com",
  projectId: "tanksgame-5ac51",
  storageBucket: "tanksgame-5ac51.firebasestorage.app",
  messagingSenderId: "416121252286",
  appId: "1:416121252286:web:bc4ed5cd9b5fdd58e771ef",
  measurementId: "G-7FB4L3C5ZW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ==========================================
        // CONFIGURACIN DEL JUEGO
        // ==========================================
        const CONFIG = {
            MAX_LIVES: 2,      // Total de vidas (corazones)
            HITS_PER_LIFE: 3,  // Golpes necesarios para perder 1 vida
            SPEED: 4,
            BULLET_SPEED: 8
        };

        // Variables Globales
        let roomId = null;
        let playerId = null;
        let isHost = false;
        let gameActive = true;
        
        // Estado local del Host
        const players = {}; 
        const bullets = [];

        // Referencias DOM
        const screens = {
            menu: document.getElementById('menu-screen'),
            game: document.getElementById('game-screen'),
            ctrl: document.getElementById('controller-screen')
        };

        // Detectar Sala en URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('sala')) document.getElementById('room-input').value = urlParams.get('sala');

        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[name].classList.add('active');
            if(name === 'ctrl') screens[name].style.display = 'flex';
        }

        // ==========================================
        // LGICA HOST (PANTALLA)
        // ==========================================
        function initHostMode() {
            isHost = true;
            roomId = Math.floor(100000 + Math.random() * 900000).toString();
            
            showScreen('game');
            document.getElementById('display-room-code').innerText = roomId;
            
            new QRCode(document.getElementById("qrcode"), {
                text: `${window.location.origin}${window.location.pathname}?sala=${roomId}`,
                width: 100, height: 100
            });

            initGameCanvas();
            setupHostFirebase();
        }

        function setupHostFirebase() {
            const roomRef = db.ref(`salas/${roomId}`);
            roomRef.set({ status: "waiting", created: Date.now() });

            // Jugador entra
            roomRef.child('jugadores').on('child_added', (snapshot) => {
                const pInfo = snapshot.val();
                players[snapshot.key] = {
                    id: snapshot.key,
                    x: Math.random() * (canvas.width - 50) + 25,
                    y: Math.random() * (canvas.height - 50) + 25,
                    color: pInfo.color,
                    nombre: pInfo.nombre,
                    angle: 0,
                    // NUEVO SISTEMA DE VIDAS
                    lives: CONFIG.MAX_LIVES,
                    currentHp: CONFIG.HITS_PER_LIFE, // 3 golpes por vida
                    input: { x: 0, y: 0, shoot: false },
                    isDead: false
                };
                updateScoreboard();
            });

            // Input
            roomRef.child('jugadores').on('child_changed', (snap) => {
                const id = snap.key;
                if (players[id] && snap.val().input) {
                    players[id].input = snap.val().input;
                }
            });

            // Desconexi贸n
            roomRef.child('jugadores').on('child_removed', (snap) => {
                delete players[snap.key];
                updateScoreboard();
                checkWinner(); // Comprobar si al salir alguien gana otro
            });

            requestAnimationFrame(gameLoop);
        }

        function checkWinner() {
            // Solo comprobar si hay juego activo y al menos hubo 2 jugadores alguna vez
            const activePlayers = Object.values(players).filter(p => !p.isDead);
            const totalPlayers = Object.keys(players).length;

            if (gameActive && totalPlayers > 1 && activePlayers.length === 1) {
                // GANADOR ENCONTRADO
                const winner = activePlayers[0];
                gameActive = false;
                
                // Mostrar en pantalla grande
                document.getElementById('winner-name').innerText = winner.nombre;
                document.getElementById('winner-overlay').style.display = 'flex';

                // Avisar a todos los m贸viles
                db.ref(`salas/${roomId}/winner`).set(winner.id);
            }
        }

        // ==========================================
        // LGICA CLIENTE (MVIL)
        // ==========================================
        function initClientMode() {
            roomId = document.getElementById('room-input').value;
            const name = document.getElementById('name-input').value || "Soldado";
            if (roomId.length !== 6) return alert("C贸digo incorrecto");

            playerId = 'p_' + Math.random().toString(36).substr(2, 9);
            const color = `hsl(${Math.random() * 360}, 70%, 50%)`;

            const playerRef = db.ref(`salas/${roomId}/jugadores/${playerId}`);
            
            playerRef.set({
                nombre: name,
                color: color,
                input: { x: 0, y: 0, shoot: false },
                status: 'alive'
            }).then(() => {
                showScreen('ctrl');
                document.getElementById('ctrl-name').innerText = name;
                document.getElementById('ctrl-name').style.color = color;
                setupController(playerRef);
            });

            playerRef.onDisconnect().remove();

            // Escuchar si me muero
            db.ref(`salas/${roomId}/jugadores/${playerId}/status`).on('value', snap => {
                if (snap.val() === 'dead') {
                    document.getElementById('dead-screen').style.display = 'flex';
                    // Desactivar controles
                    document.querySelector('.control-panel').style.pointerEvents = 'none';
                }
            });

            // Escuchar mis vidas para UI
            db.ref(`salas/${roomId}/jugadores/${playerId}/livesUI`).on('value', snap => {
                const lives = snap.val() || 0;
                let hearts = "";
                for(let i=0; i<lives; i++) hearts += "わ";
                document.getElementById('ctrl-hp').innerText = hearts;
            });

            // Escuchar Ganador Global
            db.ref(`salas/${roomId}/winner`).on('value', snap => {
                if (snap.val()) {
                    if (snap.val() === playerId) {
                        document.getElementById('mobile-win-screen').style.display = 'flex';
                    } else {
                        // Si gan贸 otro y yo no estaba muerto (caso raro) o ya vi mi pantalla de muerte
                        // Podemos mostrar qui茅n gan贸 en peque帽o o dejar la pantalla de muerte
                    }
                }
            });
        }

        function setupController(ref) {
            // (Misma l贸gica de joystick del ejemplo anterior)
            const stick = document.getElementById('joystick-stick');
            const zone = document.getElementById('joystick-zone');
            let drag = false;

            const send = (x, y, s) => ref.update({ input: { x:x, y:y, shoot:s } });

            zone.addEventListener('touchstart', e => { drag = true; stick.style.transition='none'; });
            zone.addEventListener('touchmove', e => {
                if(!drag) return;
                const t = e.touches[0];
                const rect = zone.getBoundingClientRect();
                const cx = rect.left + rect.width/2;
                const cy = rect.top + rect.height/2;
                
                let dx = t.clientX - cx;
                let dy = t.clientY - cy;
                const dist = Math.sqrt(dx*dx+dy*dy);
                const max = 40;
                
                if(dist > max) { dx = (dx/dist)*max; dy = (dy/dist)*max; }
                
                stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                send(parseFloat((dx/max).toFixed(2)), parseFloat((dy/max).toFixed(2)), false);
            });
            const end = () => { drag=false; stick.style.transition='0.2s'; stick.style.transform='translate(-50%,-50%)'; send(0,0,false); };
            zone.addEventListener('touchend', end);
            
            document.getElementById('btn-shoot').addEventListener('touchstart', e => {
                e.preventDefault();
                send(0,0,true);
                setTimeout(()=>send(0,0,false), 100);
            });
        }

        // ==========================================
        // MOTOR DE JUEGO (CANVAS)
        // ==========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function initGameCanvas() {
            canvas.width = window.innerWidth * 0.9;
            canvas.height = window.innerHeight * 0.8;
        }

        function gameLoop() {
            if (!gameActive) return; // Detener render si hay ganador

            ctx.fillStyle = "#333";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 1. Jugadores
            Object.values(players).forEach(p => {
                if (p.isDead) return;

                // Movimiento
                if (Math.abs(p.input.x) > 0.1 || Math.abs(p.input.y) > 0.1) {
                    p.x += p.input.x * CONFIG.SPEED;
                    p.y += p.input.y * CONFIG.SPEED;
                    p.angle = Math.atan2(p.input.y, p.input.x);
                }
                // Bordes
                p.x = Math.max(20, Math.min(canvas.width - 20, p.x));
                p.y = Math.max(20, Math.min(canvas.height - 20, p.y));

                // Disparo
                if (p.input.shoot && (!p.lastShot || Date.now() - p.lastShot > 500)) {
                    bullets.push({ x: p.x, y: p.y, vx: Math.cos(p.angle)*CONFIG.BULLET_SPEED, vy: Math.sin(p.angle)*CONFIG.BULLET_SPEED, owner: p.id, color: p.color });
                    p.lastShot = Date.now();
                }

                drawTank(p);
            });

            // 2. Balas
            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                b.x += b.vx; b.y += b.vy;

                ctx.fillStyle = b.color;
                ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, Math.PI*2); ctx.fill();

                if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) {
                    bullets.splice(i, 1); continue;
                }

                // Colisi贸n
                Object.values(players).forEach(p => {
                    if (p.id !== b.owner && !p.isDead) {
                        const dist = Math.sqrt((p.x-b.x)**2 + (p.y-b.y)**2);
                        if (dist < 25) {
                            bullets.splice(i, 1);
                            handleHit(p);
                        }
                    }
                });
            }
            requestAnimationFrame(gameLoop);
        }

        function drawTank(p) {
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.angle);
            ctx.fillStyle = p.color;
            ctx.fillRect(-20, -15, 40, 30); // Cuerpo
            ctx.fillStyle = "#fff"; ctx.fillRect(0, -5, 30, 10); // Ca帽贸n
            ctx.fillStyle = "#000"; ctx.fillRect(-20, -20, 40, 5); ctx.fillRect(-20, 15, 40, 5); // Orugas
            ctx.restore();

            // Barra de HP (Golpes restantes en esta vida)
            ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.fillText(p.nombre, p.x, p.y - 40);
            
            // Dibujar Corazones (Vidas)
            let hearts = "";
            for(let i=0; i<p.lives; i++) hearts += "わ";
            ctx.fillText(hearts, p.x, p.y - 55);

            // Barra Verde (Salud actual de la vida)
            const hpWidth = 40 * (p.currentHp / CONFIG.HITS_PER_LIFE);
            ctx.fillStyle = "red"; ctx.fillRect(p.x - 20, p.y - 35, 40, 5);
            ctx.fillStyle = "#0f0"; ctx.fillRect(p.x - 20, p.y - 35, hpWidth, 5);
        }

        function handleHit(p) {
            // L贸gica de da帽o
            p.currentHp--; 

            // Si se acaban los HP de esta vida
            if (p.currentHp <= 0) {
                p.lives--; // Pierde una vida
                
                // Actualizar m贸vil
                db.ref(`salas/${roomId}/jugadores/${p.id}/livesUI`).set(p.lives);

                if (p.lives > 0) {
                    // Aun le quedan vidas -> Respawn
                    p.currentHp = CONFIG.HITS_PER_LIFE; // Reset HP
                    p.x = Math.random() * canvas.width;
                    p.y = Math.random() * canvas.height;
                } else {
                    // Muerte Definitiva
                    p.isDead = true;
                    db.ref(`salas/${roomId}/jugadores/${p.id}/status`).set('dead');
                    checkWinner(); // Verificar si alguien gan贸
                }
            }
            updateScoreboard();
        }

        function updateScoreboard() {
            const board = document.getElementById('score-board');
            let html = "";
            Object.values(players).forEach(p => {
                const style = p.isDead ? "text-decoration:line-through; color:#555" : `color:${p.color}`;
                html += `<div style="${style}">${p.nombre}: ${p.lives} vidas</div>`;
            });
            board.innerHTML = html;
            document.getElementById('player-count').innerText = Object.keys(players).length;
        }

    </script>
</body>
</html>