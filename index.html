<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tanques Battle Royale (Escudos)</title>
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ESTILOS GENERALES */
        * { box-sizing: border-box; touch-action: none; user-select: none; }
        body { margin: 0; padding: 0; background: #222; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; }
        .active { display: flex; }

        /* UI MEN√ö */
        #menu-screen { background: #1a1a1a; z-index: 20; text-align: center; }
        h1 { font-size: 3rem; color: #4CAF50; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .btn { padding: 15px 30px; font-size: 1.2rem; background: #4CAF50; border: none; color: white; border-radius: 5px; margin: 10px; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: #45a049; transform: scale(1.05); }
        .btn:disabled { background: #555; cursor: not-allowed; transform: none; }
        input { padding: 15px; font-size: 1.2rem; border-radius: 5px; border: none; text-align: center; margin: 10px; width: 250px; }

        /* UI JUEGO (HOST) */
        #game-screen { background: #111; position: relative; }
        canvas { background: #000; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        
        /* Lobby Overlay */
        #lobby-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; backdrop-filter: blur(5px); transition: opacity 0.5s; }
        .lobby-content { text-align: center; background: rgba(255,255,255,0.1); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); }
        #qrcode { margin: 20px auto; background: white; padding: 10px; display: inline-block; border-radius: 5px; }
        .room-code { font-size: 4rem; color: #FFD700; font-family: monospace; font-weight: bold; letter-spacing: 5px; }
        .player-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; max-width: 600px; }
        .player-chip { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 15px; font-size: 0.9rem; }

        /* HUD IN-GAME */
        #game-hud { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 5; }
        .hud-panel { background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; margin-bottom: 5px; font-weight: bold; }

        /* PANTALLA GANADOR */
        #winner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #winner-name { font-size: 5rem; color: #FFD700; text-shadow: 0 0 30px #FFD700; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* UI CONTROL (M√ìVIL) */
        #controller-screen { background: #222; }
        .control-panel { display: flex; width: 100%; height: 100%; justify-content: space-between; align-items: center; padding: 20px; }
        #joystick-zone { width: 180px; height: 180px; background: rgba(255,255,255,0.1); border-radius: 50%; position: relative; border: 2px solid rgba(255,255,255,0.2); }
        #joystick-stick { width: 70px; height: 70px; background: rgba(255,255,255,0.5); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #btn-shoot { width: 100px; height: 100px; background: #ff4444; border-radius: 50%; border: 4px solid #cc0000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #btn-shoot:active { background: #cc0000; transform: scale(0.95); }

        .mobile-top-bar { position: absolute; top: 0; width: 100%; padding: 15px; display: flex; justify-content: space-between; background: rgba(0,0,0,0.8); font-weight: bold; border-bottom: 1px solid #444; }
        
        /* OVERLAYS M√ìVIL */
        .overlay-msg { display: none; width: 100%; height: 100%; flex-direction: column; justify-content: center; align-items: center; position: absolute; top:0; left:0; z-index: 50; text-align: center; padding: 20px; }
        #waiting-screen { background: #002233; display: flex; }
        #dead-screen { background: #220000; color: #ff5555; }
        #win-screen { background: #003300; color: #00ff00; }
    </style>
</head>
<body>

    <!-- MEN√ö PRINCIPAL -->
    <div id="menu-screen" class="screen active">
        <h1>TANK BATTLE</h1>
        <button class="btn" onclick="initHostMode()">üì∫ Crear Sala (Host)</button>
        <div style="border-top: 1px solid #444; margin: 30px auto; padding: 20px; max-width: 400px;">
            <input type="text" id="room-input" placeholder="C√≥digo de Sala" maxlength="6">
            <input type="text" id="name-input" placeholder="Tu Nombre" maxlength="10">
            <br>
            <button class="btn" onclick="initClientMode()">üéÆ Unirse</button>
        </div>
    </div>

    <!-- PANTALLA DE JUEGO (HOST) -->
    <div id="game-screen" class="screen">
        <canvas id="gameCanvas"></canvas>
        <div id="game-hud">
            <div class="hud-panel">SALA: <span id="hud-room-code"></span></div>
        </div>
        
        <!-- LOBBY -->
        <div id="lobby-overlay">
            <div class="lobby-content">
                <h2>√öNASE PARA JUGAR</h2>
                <div class="room-code" id="display-room-code">------</div>
                <div id="qrcode"></div>
                <p>Escanea o ingresa el c√≥digo</p>
                <div class="player-grid" id="lobby-list"></div>
                <br>
                <h3 id="player-count-display">0 Jugadores listos</h3>
                <button id="btn-start-game" class="btn" onclick="startGame()" disabled>ESPERANDO JUGADORES...</button>
            </div>
        </div>

        <!-- GANADOR -->
        <div id="winner-overlay">
            <h2 style="color:white">¬°VICTORIA!</h2>
            <div id="winner-name">JUGADOR</div>
            <button class="btn" onclick="location.reload()" style="margin-top:50px;">Nueva Partida</button>
        </div>
    </div>

    <!-- PANTALLA CLIENTE -->
    <div id="controller-screen" class="screen">
        <div id="waiting-screen" class="overlay-msg">
            <h1>ESPERANDO</h1><p>El anfitri√≥n iniciar√° pronto...</p>
            <div style="font-size:2rem; margin-top:20px;">‚è≥</div>
        </div>
        <div id="dead-screen" class="overlay-msg">
            <h1>ELIMINADO</h1><p>Buena batalla</p>
        </div>
        <div id="win-screen" class="overlay-msg">
            <h1>¬°CAMPE√ìN!</h1><p>Eres indestructible</p>
        </div>
        <div class="mobile-top-bar">
            <span id="ctrl-name">Jugador</span>
            <span><span id="ctrl-hp">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></span>
        </div>
        <div class="control-panel">
            <div id="joystick-zone"><div id="joystick-stick"></div></div>
            <div id="shoot-zone"><div id="btn-shoot">üî•</div></div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN FIREBASE (PONER TUS DATOS)
        // ==========================================
        const firebaseConfig = {
              apiKey: "AIzaSyBb4BGWFS5a2RA1jfyW-z1m-Ai9sMgx3yk",
                authDomain: "tanksgame-5ac51.firebaseapp.com",
                databaseURL: "https://tanksgame-5ac51-default-rtdb.firebaseio.com",
                projectId: "tanksgame-5ac51",
                storageBucket: "tanksgame-5ac51.firebasestorage.app",
                messagingSenderId: "416121252286",
                appId: "1:416121252286:web:bc4ed5cd9b5fdd58e771ef",
                measurementId: "G-7FB4L3C5ZW"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ==========================================
        // CONFIGURACI√ìN DEL JUEGO
        // ==========================================
        const CONFIG = {
            MAX_LIVES: 4,
            HP_PER_LIFE: 3,
            HEALTH_INTERVAL: 30000,
            SHIELD_INTERVAL: 60000,
            SHIELD_DURATION: 20000,      // ‚úÖ 20 segundos
            GIANT_INTERVAL: 45000,        // ‚úÖ 45 segundos
            RAPID_FIRE_INTERVAL: 60000,   // ‚úÖ 60 segundos
            SPEED: 4,
            BULLET_SPEED: 9
        };

        // Estado Global
        let roomId = null;
        let playerId = null;
        let isHost = false;
        let gameStatus = 'lobby'; 
        
        // Variables Host
        const players = {}; 
        const bullets = [];
        const gameItems = [];
        let timers = [];
        
        const bgImage = new Image();
        bgImage.src = 'background.png';

        // Referencias DOM
        const screens = {
            menu: document.getElementById('menu-screen'),
            game: document.getElementById('game-screen'),
            ctrl: document.getElementById('controller-screen')
        };

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('sala')) document.getElementById('room-input').value = urlParams.get('sala');

        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[name].classList.add('active');
            if(name === 'ctrl') screens[name].style.display = 'flex';
        }

        // ==========================================
        // L√ìGICA HOST
        // ==========================================
        function initHostMode() {
            isHost = true;
            roomId = Math.floor(100000 + Math.random() * 900000).toString();
            
            showScreen('game');
            document.getElementById('display-room-code').innerText = roomId;
            document.getElementById('hud-room-code').innerText = roomId;
            
            new QRCode(document.getElementById("qrcode"), {
                text: `${window.location.origin}${window.location.pathname}?sala=${roomId}`,
                width: 128, height: 128
            });

            initGameCanvas();
            setupHostFirebase();
        }

        function setupHostFirebase() {
            const roomRef = db.ref(`salas/${roomId}`);
            roomRef.set({ status: "lobby", created: Date.now() });

            roomRef.child('jugadores').on('child_added', (snapshot) => {
                const pInfo = snapshot.val();
                players[snapshot.key] = {
                    id: snapshot.key,
                    x: Math.random() * (canvas.width - 100) + 50,
                    y: Math.random() * (canvas.height - 100) + 50,
                    color: pInfo.color,
                    nombre: pInfo.nombre,
                    angle: 0,
                    lives: CONFIG.MAX_LIVES,
                    currentHp: CONFIG.HP_PER_LIFE,
                    input: { x: 0, y: 0, shoot: false },
                    isDead: false,
                    shieldExpires: 0,
                    isGiant: false,        // ‚úÖ Nuevo poder
                    hasRapidFire: false    // ‚úÖ Nuevo poder
                };
                updateLobbyUI();
            });

            roomRef.child('jugadores').on('child_changed', (snap) => {
                const id = snap.key;
                if (players[id] && snap.val().input) players[id].input = snap.val().input;
            });

            roomRef.child('jugadores').on('child_removed', (snap) => {
                delete players[snap.key];
                updateLobbyUI();
                if(gameStatus === 'playing') checkWinner();
            });

            requestAnimationFrame(gameLoop);
        }

        function updateLobbyUI() {
            const list = document.getElementById('lobby-list');
            const count = Object.keys(players).length;
            const btn = document.getElementById('btn-start-game');
            
            document.getElementById('player-count-display').innerText = `${count} Jugadores listos`;
            list.innerHTML = Object.values(players)
                .map(p => `<div class="player-chip" style="border:2px solid ${p.color}">${p.nombre}</div>`)
                .join('');

            if (count >= 2) {
                btn.disabled = false; btn.innerText = "INICIAR PARTIDA"; btn.style.background = "#4CAF50";
            } else {
                btn.disabled = true; btn.innerText = "ESPERANDO M√ÅS JUGADORES..."; btn.style.background = "#555";
            }
        }

        function startGame() {
            gameStatus = 'playing';
            document.getElementById('lobby-overlay').style.opacity = '0';
            setTimeout(() => { document.getElementById('lobby-overlay').style.display = 'none'; }, 500);
            db.ref(`salas/${roomId}`).update({ status: 'playing' });

            // Spawners
            timers.push(setInterval(() => spawnItem('health'), CONFIG.HEALTH_INTERVAL));
            timers.push(setInterval(() => spawnItem('shield'), CONFIG.SHIELD_INTERVAL));
            timers.push(setInterval(() => spawnItem('giant'), CONFIG.GIANT_INTERVAL));        // ‚úÖ
            timers.push(setInterval(() => spawnItem('rapidfire'), CONFIG.RAPID_FIRE_INTERVAL)); // ‚úÖ
        }

        function spawnItem(type) {
            if (gameStatus !== 'playing') return;
            if (gameItems.length >= 5) return;

            gameItems.push({
                type: type,
                x: Math.random() * (canvas.width - 60) + 30,
                y: Math.random() * (canvas.height - 60) + 30,
                radius: 15,
                pulse: 0
            });
        }

        function checkWinner() {
            const activePlayers = Object.values(players).filter(p => !p.isDead);
            if (activePlayers.length === 1 && Object.keys(players).length > 1) {
                gameStatus = 'ended';
                const winner = activePlayers[0];
                document.getElementById('winner-name').innerText = winner.nombre;
                document.getElementById('winner-overlay').style.display = 'flex';
                db.ref(`salas/${roomId}/winner`).set(winner.id);
                timers.forEach(t => clearInterval(t));
            }
        }

        // ==========================================
        // L√ìGICA CLIENTE
        // ==========================================
        function initClientMode() {
            const code = document.getElementById('room-input').value;
            const name = document.getElementById('name-input').value || "Tanque";
            if (code.length < 5) return alert("C√≥digo inv√°lido");
            roomId = code;
            
            playerId = 'p_' + Math.random().toString(36).substr(2, 9);
            const color = `hsl(${Math.random() * 360}, 75%, 50%)`;

            const playerRef = db.ref(`salas/${roomId}/jugadores/${playerId}`);
            playerRef.set({
                nombre: name, color: color,
                input: { x: 0, y: 0, shoot: false },
                livesUI: CONFIG.MAX_LIVES
            }).then(() => {
                showScreen('ctrl');
                document.getElementById('ctrl-name').innerText = name;
                document.getElementById('ctrl-name').style.color = color;
                setupController(playerRef);
            });

            playerRef.onDisconnect().remove();

            db.ref(`salas/${roomId}/status`).on('value', snap => {
                const status = snap.val();
                const wait = document.getElementById('waiting-screen');
                if (status === 'playing') wait.style.display = 'none';
                else if (status === 'lobby') wait.style.display = 'flex';
            });

            db.ref(`salas/${roomId}/jugadores/${playerId}`).on('value', snap => {
                const data = snap.val();
                if (!data) return;
                document.getElementById('ctrl-hp').innerText = "‚ù§Ô∏è".repeat(data.livesUI);
                if (data.status === 'dead') {
                    document.getElementById('dead-screen').style.display = 'flex';
                    document.querySelector('.control-panel').style.pointerEvents = 'none';
                }
            });

            db.ref(`salas/${roomId}/winner`).on('value', snap => {
                if (snap.val() === playerId) document.getElementById('win-screen').style.display = 'flex';
            });
        }

        function setupController(ref) {
            const stick = document.getElementById('joystick-stick');
            const zone = document.getElementById('joystick-zone');
            let drag = false;
            const send = (x, y, s) => ref.update({ input: { x:x, y:y, shoot:s } });

            zone.addEventListener('touchstart', e => { drag = true; stick.style.transition='none'; });
            zone.addEventListener('touchmove', e => {
                if(!drag) return;
                const t = e.touches[0];
                const rect = zone.getBoundingClientRect();
                const dx = t.clientX - (rect.left + rect.width/2);
                const dy = t.clientY - (rect.top + rect.height/2);
                const dist = Math.sqrt(dx*dx+dy*dy);
                const max = 40;
                const lx = dist > max ? (dx/dist)*max : dx;
                const ly = dist > max ? (dy/dist)*max : dy;
                stick.style.transform = `translate(calc(-50% + ${lx}px), calc(-50% + ${ly}px))`;
                send(parseFloat((lx/max).toFixed(2)), parseFloat((ly/max).toFixed(2)), false);
            });
            const end = () => { drag=false; stick.style.transition='0.2s'; stick.style.transform='translate(-50%,-50%)'; send(0,0,false); };
            zone.addEventListener('touchend', end);
            
            document.getElementById('btn-shoot').addEventListener('touchstart', e => {
                e.preventDefault(); send(0,0,true); setTimeout(()=>send(0,0,false), 100);
            });
        }

        // ==========================================
        // MOTOR DE JUEGO
        // ==========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function initGameCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function gameLoop() {
            ctx.fillStyle = "#111";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (bgImage.complete) ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

            if (gameStatus !== 'playing') { requestAnimationFrame(gameLoop); return; }

            // 1. Dibujar Items
            for (let i = gameItems.length - 1; i >= 0; i--) {
                const item = gameItems[i];
                item.pulse += 0.1;
                const scale = 1 + Math.sin(item.pulse) * 0.1;
                
                ctx.save();
                ctx.translate(item.x, item.y);
                ctx.scale(scale, scale);
                
                ctx.shadowBlur = 15;
                if (item.type === 'health') {
                    ctx.fillStyle = "#00ff00"; ctx.shadowColor = "#00ff00";
                    ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = "white"; ctx.font = "bold 14px Arial"; 
                    ctx.textAlign = "center"; ctx.textBaseline="middle"; ctx.fillText("+", 0, 1);
                } else if (item.type === 'shield') {
                    ctx.fillStyle = "#00ffff"; ctx.shadowColor = "#00ffff";
                    ctx.beginPath(); ctx.arc(0, 0, 12, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = "#FFD700"; ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.fill();
                } else if (item.type === 'giant') { // ‚úÖ
                    ctx.fillStyle = "#ff0000"; ctx.shadowColor = "#ff0000";
                    ctx.beginPath(); ctx.arc(0, 0, 12, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = "white"; ctx.font = "bold 16px Arial";
                    ctx.fillText("‚¨Ü", 0, 1);
                } else if (item.type === 'rapidfire') { // ‚úÖ
                    ctx.fillStyle = "#ff8800"; ctx.shadowColor = "#ff8800";
                    ctx.beginPath(); ctx.arc(0, 0, 12, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = "white"; ctx.font = "bold 12px Arial";
                    ctx.fillText("‚ö°", 0, 1);
                }
                ctx.restore();
            }

            // 2. Jugadores
            Object.values(players).forEach(p => {
                if (p.isDead) return;

                // F√≠sica
                if (Math.abs(p.input.x) > 0.1 || Math.abs(p.input.y) > 0.1) {
                    p.x += p.input.x * CONFIG.SPEED;
                    p.y += p.input.y * CONFIG.SPEED;
                    p.angle = Math.atan2(p.input.y, p.input.x);
                }
                p.x = Math.max(30, Math.min(canvas.width - 30, p.x));
                p.y = Math.max(30, Math.min(canvas.height - 30, p.y));

                // Colisi√≥n Items
                for (let i = gameItems.length - 1; i >= 0; i--) {
                    const item = gameItems[i];
                    const hitRadius = p.isGiant ? 50 : 35; // ‚úÖ Hitbox aumentado
                    if (Math.hypot(p.x - item.x, p.y - item.y) < hitRadius) {
                        if (item.type === 'health') {
                            p.currentHp = CONFIG.HP_PER_LIFE;
                        } else if (item.type === 'shield') {
                            p.shieldExpires = Date.now() + CONFIG.SHIELD_DURATION;
                        } else if (item.type === 'giant') { // ‚úÖ
                            p.isGiant = true;
                        } else if (item.type === 'rapidfire') { // ‚úÖ
                            p.hasRapidFire = true;
                        }
                        gameItems.splice(i, 1);
                    }
                }

                // Disparo
                const fireRate = p.hasRapidFire ? 250 : 500; // ‚úÖ
                if (p.input.shoot && (!p.lastShot || Date.now() - p.lastShot > fireRate)) {
                    const bulletSize = p.isGiant ? 12 : 6; // ‚úÖ
                    bullets.push({ 
                        x: p.x, y: p.y, 
                        vx: Math.cos(p.angle)*CONFIG.BULLET_SPEED, 
                        vy: Math.sin(p.angle)*CONFIG.BULLET_SPEED, 
                        owner: p.id, color: p.color,
                        size: bulletSize // ‚úÖ
                    });
                    p.lastShot = Date.now();
                }

                drawTank(p);
            });

            // 3. Balas
            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                b.x += b.vx; b.y += b.vy;

                ctx.fillStyle = b.color;
                ctx.shadowBlur = 10; ctx.shadowColor = b.color;
                ctx.beginPath(); ctx.arc(b.x, b.y, b.size, 0, Math.PI*2); ctx.fill(); // ‚úÖ
                ctx.shadowBlur = 0;

                if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) {
                    bullets.splice(i, 1); continue;
                }

                Object.values(players).forEach(p => {
                    if (p.id !== b.owner && !p.isDead) {
                        const hitDist = p.isGiant ? 40 : 25; // ‚úÖ
                        if (Math.hypot(p.x - b.x, p.y - b.y) < hitDist) {
                            bullets.splice(i, 1);
                            handleHit(p);
                        }
                    }
                });
            }
            requestAnimationFrame(gameLoop);
        }

        function drawTank(p) {
            const scale = p.isGiant ? 2 : 1; // ‚úÖ
            
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.angle);
            ctx.scale(scale, scale); // ‚úÖ
            
            // SOMBRA
            ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 10;
            
            // COLOR DEL TANQUE
            const isShielded = p.shieldExpires > Date.now();
            ctx.fillStyle = isShielded ? "#FFD700" : p.color;

            // CUERPO
            ctx.fillRect(-20, -15, 40, 30);
            
            // CA√ë√ìN (ancho x2 si tiene rapid fire) ‚úÖ
            const cannonWidth = p.hasRapidFire ? 20 : 10;
            ctx.fillStyle = isShielded ? "#FFFACD" : "#fff";
            ctx.fillRect(0, -cannonWidth/2, 30, cannonWidth);
            
            ctx.fillStyle = "#111"; ctx.fillRect(-20, -20, 40, 5); ctx.fillRect(-20, 15, 40, 5);
            
            // ESCUDO
            if (isShielded) {
                ctx.strokeStyle = `rgba(255, 215, 0, ${0.5 + Math.sin(Date.now()/100)*0.3})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(0, 0, 35, 0, Math.PI*2);
                ctx.stroke();
            }
            
            ctx.restore();

            // HUD Flotante
            ctx.shadowBlur = 0;
            ctx.fillStyle = "white"; ctx.font = "bold 12px Arial"; ctx.textAlign = "center";
            ctx.fillText(p.nombre, p.x, p.y - 45 * scale); // ‚úÖ
            
            let hearts = "‚ù§Ô∏è".repeat(p.lives);
            ctx.font = "14px Arial";
            ctx.fillText(hearts, p.x, p.y - 60 * scale); // ‚úÖ

            const hpPct = p.currentHp / CONFIG.HP_PER_LIFE;
            const barWidth = 40 * scale; // ‚úÖ
            ctx.fillStyle = "red"; ctx.fillRect(p.x - barWidth/2, p.y - 35 * scale, barWidth, 6);
            ctx.fillStyle = "#0f0"; ctx.fillRect(p.x - barWidth/2, p.y - 35 * scale, barWidth * hpPct, 6);
            ctx.strokeStyle = "black"; ctx.strokeRect(p.x - barWidth/2, p.y - 35 * scale, barWidth, 6);
        }

        function handleHit(p) {
            if (p.shieldExpires > Date.now()) return;

            p.currentHp--;
            if (p.currentHp <= 0) {
                p.lives--;
                db.ref(`salas/${roomId}/jugadores/${p.id}/livesUI`).set(p.lives);

                if (p.lives > 0) {
                    p.currentHp = CONFIG.HP_PER_LIFE;
                    p.x = Math.random() * (canvas.width-50)+25;
                    p.y = Math.random() * (canvas.height-50)+25;
                    p.shieldExpires = 0;
                    p.isGiant = false;      // ‚úÖ Perder poder al morir
                    p.hasRapidFire = false; // ‚úÖ Perder poder al morir
                } else {
                    p.isDead = true;
                    db.ref(`salas/${roomId}/jugadores/${p.id}/status`).set('dead');
                    checkWinner();
                }
            }
        }
    </script>
</body>
</html>